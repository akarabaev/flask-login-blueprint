{% extends 'base.html' %}


{% block content %}


<div class="bg-white p-4 p-lg-5" id="register">
    <div v-if="flashMessage != null" class="text-center text-success mb-4">[[ flashMessage ]]</div>
    <h2 class="mb-4 text-dark">Войти</h2>
    <!-- <p class="mb-4">Use this awesome form to sign in users.</p> -->
    <form @submit.prevent="onSubmit">
        <div class="mb-3">
            <div class="input-group">
                <span class="bg-light input-group-text" id="addon-wrapping1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em">
                        <g>
                            <path fill="none" d="M0 0h24v24H0z"></path>
                            <path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm17 4.238l-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"></path>
                        </g>
                    </svg>
                </span>
                <input 
                    v-model="email" type="text" class="form-control" placeholder="Введите email" 
                    aria-label="User Email" aria-describedby="addon-wrapping1"
                >
            </div>
            <div v-if="emailValidationErrorMessage !== null" class="text-danger">[[ emailValidationErrorMessage ]]</div>
        </div>
        <div class="mb-3">
            <div class="input-group">
                <span class="bg-light input-group-text" id="addon-wrapping2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em">
                        <g>
                            <path fill="none" d="M0 0h24v24H0z"></path>
                            <path d="M10.758 11.828l7.849-7.849 1.414 1.414-1.414 1.415 2.474 2.474-1.414 1.415-2.475-2.475-1.414 1.414 2.121 2.121-1.414 1.415-2.121-2.122-2.192 2.192a5.002 5.002 0 0 1-7.708 6.294 5 5 0 0 1 6.294-7.708zm-.637 6.293A3 3 0 1 0 5.88 13.88a3 3 0 0 0 4.242 4.242z"></path>
                        </g>
                    </svg></span>
                <input v-model="password" type="password" class="form-control" placeholder="Введите пароль" aria-label="Password" aria-describedby="addon-wrapping2"/>
            </div>
            <div v-if="passwordValidationErrorMessage !== null" class="text-danger">[[ passwordValidationErrorMessage ]]</div>
        </div>
        <div class="mb-3 form-check">
            <input v-model="rememberMe" type="checkbox" class="form-check-input" id="exampleCheck1"/>
            <label class="form-check-label" for="exampleCheck1">Запомнить меня</label>
        </div>
        <div v-if="formErrorMessage != null" class="text-danger mb-3 input-group">[[ formErrorMessage ]]</div>
        <button type="submit" class="btn d-block w-100 btn-primary fw-bold pb-2 ps-3 pe-3 pt-2">Войти</button>
        <div class="mb-3 text-center form-check mt-3">
            <a @click="redirectToPasswordResetPage" class="link-primary">Забыли пароль?</a>
        </div>
    </form>
</div>


<script>
    new Vue({ 
      el: '#register',
      delimiters: ['[[', ']]'],
      data() {
        return {
            email: null,
            emailValidationErrorMessage: null,
            password: null,
            passwordValidationErrorMessage: null,
            rememberMe: null,
            formErrorMessage: null,
            flashMessage: null
        }
      }, 
      methods: {
        async onSubmit() {
            let formWasFilledIncorrectly = false;

            if (this.email == null){
                this.emailValidationErrorMessage = 'Пожалуйста введите email'
                formWasFilledIncorrectly = true
            }
            else {
                this.emailValidationErrorMessage = null
            }

            if (this.password == null){
                this.passwordValidationErrorMessage = 'Пожалуйста введите пароль'
                formWasFilledIncorrectly = true
            }
            else {
                this.passwordValidationErrorMessage = null
            }

            if (formWasFilledIncorrectly){
                return;
            }

            const response = await axios.post(
                '/login', 
                { 
                    email: this.email,
                    password: this.password,
                    rememberMe: this.rememberMe
                }
            )

            if (response.data['formErrorMessage']){
                this.formErrorMessage = response.data['formErrorMessage']
                return;
            }
            location.href = `${response.data['redirect_url']}`
        },
        redirectToPasswordResetPage() {
            location.href = '/reset_password_request'
        }
      },
      mounted(){
        console.log('inside mounted')
        const urlParams = new URLSearchParams(window.location.search);
        console.log(urlParams.get('flash'))
        let flashMessage = urlParams.get('flash')
        if (flashMessage == 'successfulRegistration'){
            this.flashMessage = 'Регистрация прошла успешно'
        }
        else if (flashMessage == 'successfulResetPassword'){
            this.flashMessage = 'Сброс пароля прошел успешно'
        }
      }
  })
</script>



{% endblock %}
